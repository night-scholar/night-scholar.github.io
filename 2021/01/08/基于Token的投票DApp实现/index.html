<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Night Scholar">





<title>基于Token的投票DApp实现 | Night-Scholar’s Blog</title>



    <link rel="icon" href="/avatar.jpeg">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 5.4.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">夜行书生&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">文章</a>
                
                    <a class="menu-item" href="/category">分类</a>
                
                    <a class="menu-item" href="/tag">标签</a>
                
                    <a class="menu-item" target="_blank" rel="noopener" href="https://bafybeibjnkt6a5g5mccqyqjb2zdiveizwaueyt522dl2ctgfz642hztx34.ipfs.infura-ipfs.io/">IPFS</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">夜行书生&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">文章</a>
                
                    <a class="menu-item" href="/category">分类</a>
                
                    <a class="menu-item" href="/tag">标签</a>
                
                    <a class="menu-item" target="_blank" rel="noopener" href="https://bafybeibjnkt6a5g5mccqyqjb2zdiveizwaueyt522dl2ctgfz642hztx34.ipfs.infura-ipfs.io/">IPFS</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
        
            <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">全部展开</a>
        <a onclick="go_top()">回到首部</a>
        <a onclick="go_bottom()">直达底部</a>
    </div>
</div>

<script>
    document.ready(
        function() {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "全部折叠"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "全部展开"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }
</script>
                

                    
                        <article class="post-wrap">
                            <header class="post-header">
                                <h1 class="post-title">
                                    基于Token的投票DApp实现
                                </h1>
                                
                                    <div class="post-meta">
                                        
                                            Author:
                                            <a itemprop="author" rel="author" href="/">
                                                Night Scholar
                                            </a>
                                            

                                                
                                                    <span class="post-time">
                        Date: <a href="#">January 8, 2021&nbsp;&nbsp;18:55:02</a>
                        </span>
                                                    
                                                        
                                                            <span class="post-category">
                    Category:
                            
                                <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/">区块链</a>
                            
                        </span>
                                                            
                                    </div>
                                    
                            </header>

                            <div class="post-content">
                                <h1 id="基于Token的投票DApp实现"><a href="#基于Token的投票DApp实现" class="headerlink" title="基于Token的投票DApp实现"></a>基于Token的投票DApp实现</h1><p>Token相当于代币，它除了可以代表一份权益，还可以代表一种荣誉、积分，也可以转化为物权。本文对基于Token的投票DApp做一个实现。</p>
<p>与不使用Token的投票不同，基于Token的投票可以选择使用ETH购买Token，对候选者进行加权投票，因此投票合约会与之前基于Truffle的简单投票有所不同。基于Truffle的投票DApp：<a target="_blank" rel="noopener" href="https://night-scholar.github.io/2020/12/12/%E5%9F%BA%E4%BA%8ETruffle%E7%9A%84%E6%8A%95%E7%A5%A8DApp%E5%AE%9E%E7%8E%B0/">https://night-scholar.github.io/2020/12/12/%E5%9F%BA%E4%BA%8ETruffle%E7%9A%84%E6%8A%95%E7%A5%A8DApp%E5%AE%9E%E7%8E%B0/</a></p>
<h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><p>和之前一样，我们需要安装Truffle和创建项目。</p>
<h4 id="安装Truffle"><a href="#安装Truffle" class="headerlink" title="安装Truffle"></a>安装Truffle</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g truffle </span><br></pre></td></tr></table></figure>

<h3 id="创建项目-1"><a href="#创建项目-1" class="headerlink" title="创建项目"></a>创建项目</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir Voting_By_Truffle_DApp</span><br><span class="line">cd Voting_By_Truffle_DApp</span><br><span class="line">npm install -g webpack</span><br><span class="line">truffle unbox webpack</span><br></pre></td></tr></table></figure>

<h2 id="项目实现"><a href="#项目实现" class="headerlink" title="项目实现"></a>项目实现</h2><h3 id="Voting-sol"><a href="#Voting-sol" class="headerlink" title="Voting.sol"></a>Voting.sol</h3><p>首先肯定和之前一样，删除contracts下除了Migration.sol以外的其他合约并新建Voting.sol，代码实现如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity &gt;=0.4.21 &lt;0.7.0;</span><br><span class="line"></span><br><span class="line">contract Voting &#123;</span><br><span class="line">    struct voter &#123;</span><br><span class="line">        address voterAddress;</span><br><span class="line">        uint256 tokenNum;</span><br><span class="line">        uint256[] tokensVoteForCandidates;</span><br><span class="line">    &#125;</span><br><span class="line">    uint256 public totalTokens;</span><br><span class="line">    uint256 public tokenBalance;</span><br><span class="line">    uint256 public tokenPrice;</span><br><span class="line">    bytes32[] candidateList;</span><br><span class="line">    mapping(bytes32 =&gt; uint256) public votesReceived;</span><br><span class="line">    mapping(address =&gt; voter) public voterInfo;</span><br><span class="line"></span><br><span class="line">    constructor(</span><br><span class="line">        uint256 totalSupply,</span><br><span class="line">        uint256 price,</span><br><span class="line">        bytes32[] memory candidateNames</span><br><span class="line">    ) public &#123;</span><br><span class="line">        totalTokens = totalSupply;</span><br><span class="line">        tokenBalance = totalSupply;</span><br><span class="line">        tokenPrice = price;</span><br><span class="line">        candidateList = candidateNames;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function buy() public payable returns (uint256) &#123;</span><br><span class="line">        uint256 tokensToBuy = msg.value / tokenPrice;</span><br><span class="line">        require(tokensToBuy &lt;= tokenBalance);</span><br><span class="line">        voterInfo[msg.sender].voterAddress = msg.sender;</span><br><span class="line">        voterInfo[msg.sender].tokenNum += tokensToBuy;</span><br><span class="line">        tokenBalance -= tokensToBuy;</span><br><span class="line">        return tokensToBuy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function voteForCandidate(bytes32 candidate, uint256 voteTokens) public &#123;</span><br><span class="line">        uint256 index = indexOfCandidate(candidate);</span><br><span class="line">        require(index != uint256(-1));</span><br><span class="line">        if (voterInfo[msg.sender].tokensVoteForCandidates.length == 0) &#123;</span><br><span class="line">            for (uint256 i = 0; i &lt; candidateList.length; i++) &#123;</span><br><span class="line">                voterInfo[msg.sender].tokensVoteForCandidates.push(0);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        uint256 availableTokens = voterInfo[msg.sender].tokenNum -</span><br><span class="line">            totalUsedTokens(voterInfo[msg.sender].tokensVoteForCandidates);</span><br><span class="line">        require(availableTokens &gt;= voteTokens);</span><br><span class="line">        votesReceived[candidate] += voteTokens;</span><br><span class="line">        voterInfo[msg.sender].tokensVoteForCandidates[index] += voteTokens;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function totalVotesFor(bytes32 candidate) public view returns (uint256) &#123;</span><br><span class="line">        return votesReceived[candidate];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function totalUsedTokens(uint256[] memory votesForCandidate)</span><br><span class="line">        public</span><br><span class="line">        pure</span><br><span class="line">        returns (uint256)</span><br><span class="line">    &#123;</span><br><span class="line">        uint256 voterTotalTokens = 0;</span><br><span class="line">        for (uint256 i = 0; i &lt; votesForCandidate.length; i++) &#123;</span><br><span class="line">            voterTotalTokens += votesForCandidate[i];</span><br><span class="line">        &#125;</span><br><span class="line">        return uint256(voterTotalTokens);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function indexOfCandidate(bytes32 candidate) public view returns (uint256) &#123;</span><br><span class="line">        for (uint256 i = 0; i &lt; candidateList.length; i++) &#123;</span><br><span class="line">            if (candidate == candidateList[i]) &#123;</span><br><span class="line">                return i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return uint256(-1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function tokenSold() public view returns (uint256) &#123;</span><br><span class="line">        return totalTokens - tokenBalance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function voterDetails(address voterAddr)</span><br><span class="line">        public</span><br><span class="line">        view</span><br><span class="line">        returns (uint256, uint256[] memory)</span><br><span class="line">    &#123;</span><br><span class="line">        return (</span><br><span class="line">            voterInfo[voterAddr].tokenNum,</span><br><span class="line">            voterInfo[voterAddr].tokensVoteForCandidates</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function allCandidate() public view returns (bytes32[] memory) &#123;</span><br><span class="line">        return candidateList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address payable _to) public &#123;</span><br><span class="line">        _to.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-deploy-contracts-js"><a href="#2-deploy-contracts-js" class="headerlink" title="2_deploy_contracts.js"></a>2_deploy_contracts.js</h3><p>修改migrations下的2_deploy_contracts.js文件，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Voting = artifacts.require(<span class="string">&#x27;./Voting.sol&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">deployer</span>) </span>&#123;</span><br><span class="line">    deployer.deploy(Voting, <span class="number">10000</span>, web3.utils.toWei(<span class="number">0.01</span>.toString(), <span class="string">&#x27;ether&#x27;</span>), [<span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;Cary&#x27;</span>].map(<span class="function"><span class="params">x</span> =&gt;</span> web3.utils.asciiToHex(x)), &#123; <span class="attr">gas</span>: <span class="number">2000000</span> &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>10000, web3.utils.toWei(0.01.toString(), ‘ether’), [‘Alice’, ‘Bob’, ‘Cary’].map(x =&gt; web3.utils.asciiToHex(x))分别对应合约构造函数下的各个变量。</p>
<h3 id="合约测试"><a href="#合约测试" class="headerlink" title="合约测试"></a>合约测试</h3><h4 id="编译合约"><a href="#编译合约" class="headerlink" title="编译合约"></a>编译合约</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truffle compile</span><br></pre></td></tr></table></figure>

<h4 id="部署合约"><a href="#部署合约" class="headerlink" title="部署合约"></a>部署合约</h4><p>这一步注意修改truffle.config.js下的development，端口号要与geth、ganache或者truffle开启的区块链端口保持一致。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truffle migrate</span><br></pre></td></tr></table></figure>

<p>部署完毕后，看一下是否生成了块，如果生成了则部署成功，geth需要挖矿才能出块。</p>
<h4 id="进入控制台"><a href="#进入控制台" class="headerlink" title="进入控制台"></a>进入控制台</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truffle console</span><br></pre></td></tr></table></figure>

<h4 id="购买Token"><a href="#购买Token" class="headerlink" title="购买Token"></a>购买Token</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Voting.deployed().then(inst =&gt; inst.buy(&#123;value:web3.utils.toWei((10).toString(),&#x27;ether&#x27;)&#125;).then(res=&gt;console.log(res)))</span><br></pre></td></tr></table></figure>

<h4 id="查看购买的Token数量"><a href="#查看购买的Token数量" class="headerlink" title="查看购买的Token数量"></a>查看购买的Token数量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">addresses = await web3.eth.getAccounts()</span><br><span class="line">Voting.deployed().then(inst =&gt; inst.voterDetails(addresses[0]).then(res=&gt;console.log(res[0].toString())))</span><br></pre></td></tr></table></figure>

<h4 id="查看出售了的Token数量"><a href="#查看出售了的Token数量" class="headerlink" title="查看出售了的Token数量"></a>查看出售了的Token数量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Voting.deployed().then(inst =&gt; inst.tokenSold().then(res=&gt;console.log(res.toString())))</span><br></pre></td></tr></table></figure>

<h4 id="查看剩余可出售的Token数量"><a href="#查看剩余可出售的Token数量" class="headerlink" title="查看剩余可出售的Token数量"></a>查看剩余可出售的Token数量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Voting.deployed().then(inst =&gt; inst.tokenBalance().then(res=&gt;console.log(res.toString())))</span><br></pre></td></tr></table></figure>

<h4 id="查看各候选者名称"><a href="#查看各候选者名称" class="headerlink" title="查看各候选者名称"></a>查看各候选者名称</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Voting.deployed().then(inst =&gt; inst.allCandidate().then(res=&gt;console.log(web3.utils.hexToUtf8(res[0]))))</span><br><span class="line">Voting.deployed().then(inst =&gt; inst.allCandidate().then(res=&gt;console.log(web3.utils.hexToUtf8(res[1]))))</span><br><span class="line">Voting.deployed().then(inst =&gt; inst.allCandidate().then(res=&gt;console.log(web3.utils.hexToUtf8(res[2]))))</span><br></pre></td></tr></table></figure>

<h4 id="使用Token投票"><a href="#使用Token投票" class="headerlink" title="使用Token投票"></a>使用Token投票</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Voting.deployed().then(inst =&gt; inst.voteForCandidate(web3.utils.asciiToHex(&quot;Alice&quot;),10).then(res=&gt;console.log(res)))</span><br></pre></td></tr></table></figure>

<h4 id="查看Alice得票数"><a href="#查看Alice得票数" class="headerlink" title="查看Alice得票数"></a>查看Alice得票数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Voting.deployed().then(inst=&gt;inst.totalVotesFor(web3.utils.asciiToHex(&quot;Alice&quot;)).then(res=&gt;console.log(res.toString())))</span><br></pre></td></tr></table></figure>

<p>无法直接查询剩余票数，要根据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">addresses = await web3.eth.getAccounts()</span><br><span class="line">Voting.deployed().then(inst =&gt; inst.voterDetails(addresses[0]).then(res=&gt;console.log(res[0].toString())))</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">1000 <span class="comment">#购买的总票数</span></span></span><br></pre></td></tr></table></figure>

<p>和</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Voting.deployed().then(inst =&gt; inst.voterDetails(addresses[0]).then(res=&gt;console.log(res[1][0].toString())))</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">10 <span class="comment">#投Alice的10票</span></span></span><br><span class="line">Voting.deployed().then(inst =&gt; inst.voterDetails(addresses[0]).then(res=&gt;console.log(res[1][1].toString())))</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">0</span></span><br><span class="line">Voting.deployed().then(inst =&gt; inst.voterDetails(addresses[0]).then(res=&gt;console.log(res[1][2].toString())))</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">0</span></span><br></pre></td></tr></table></figure>

<p>得出的结果相减</p>
<h3 id="Index-html"><a href="#Index-html" class="headerlink" title="Index.html"></a>Index.html</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Token投票DApp<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&#x27;https://fonts.googleapis.com/css?family=Open+Sans:400,700&#x27;</span> <span class="attr">rel</span>=<span class="string">&#x27;stylesheet&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;text/css&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&#x27;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css&#x27;</span> <span class="attr">rel</span>=<span class="string">&#x27;stylesheet&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;text/css&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">&quot;text-center banner&quot;</span>&gt;</span>Token投票DApp<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row margin-top-3&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-12&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h3</span>&gt;</span>使用教程<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">strong</span>&gt;</span>第一步<span class="tag">&lt;/<span class="name">strong</span>&gt;</span>: 安装metamask插件并导入账户。</span><br><span class="line">                <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">strong</span>&gt;</span>第二步<span class="tag">&lt;/<span class="name">strong</span>&gt;</span>: 购买Token</span><br><span class="line">                <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">strong</span>&gt;</span>第三步<span class="tag">&lt;/<span class="name">strong</span>&gt;</span>: 进行投票</span><br><span class="line">                <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">strong</span>&gt;</span>第四步<span class="tag">&lt;/<span class="name">strong</span>&gt;</span>: 根据自己账户地址查看给谁投票了</span><br><span class="line">                <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row margin-top-3&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-7&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span>投票情况<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;table-responsive&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;table table-bordered&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">th</span>&gt;</span>候选人<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">th</span>&gt;</span>投票数<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">tbody</span> <span class="attr">id</span>=<span class="string">&quot;candidate-rows&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-offset-1 col-sm-4&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Token代币<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;table-responsive&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;table table-bordered&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span>&gt;</span>代币信息<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span>&gt;</span>详情<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">td</span>&gt;</span>总代币(包括已经出售的)<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">td</span> <span class="attr">id</span>=<span class="string">&quot;tokens-total&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">td</span>&gt;</span>代币已售<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">td</span> <span class="attr">id</span>=<span class="string">&quot;tokens-sold&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">td</span>&gt;</span>代币价格<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">td</span> <span class="attr">id</span>=<span class="string">&quot;tokens-cost&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">td</span>&gt;</span>合同余额<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">td</span> <span class="attr">id</span>=<span class="string">&quot;contract-balance&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row margin-bottom-3&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-7 form&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span>投票<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;msg&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;candidate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入候选人姓名&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;vote-tokens&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入投票数&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;voteForCandidate(); return false;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span>&gt;</span>投票<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-offset-1 col-sm-4&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-12 form&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>购买Token代币<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;buy-msg&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;buy&quot;</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-8&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入需要购买的代币数量&quot;</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;buyTokens(); return false;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span>&gt;</span>购买<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-12 margin-top-3 form&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">&quot;&quot;</span>&gt;</span>查看自身详情<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;voter-info&quot;</span> , <span class="attr">class</span>=<span class="string">&quot;col-sm-8&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入你的地址&quot;</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;lookupVoterInfo(); return false;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span>&gt;</span>查询<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;voter-details row text-left&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;tokens-bought&quot;</span> <span class="attr">class</span>=<span class="string">&quot;margin-top-3 col-md-12&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;votes-cast&quot;</span> <span class="attr">class</span>=<span class="string">&quot;col-md-12&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-3.1.1.slim.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;index.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Index-js"><a href="#Index-js" class="headerlink" title="Index.js"></a>Index.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">default</span> <span class="keyword">as</span> Web3 &#125; <span class="keyword">from</span> <span class="string">&#x27;web3&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">default</span> <span class="keyword">as</span> contract &#125; <span class="keyword">from</span> <span class="string">&#x27;truffle-contract&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> voting_artifacts <span class="keyword">from</span> <span class="string">&#x27;../../build/contracts/Voting.json&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Voting = contract(voting_artifacts);</span><br><span class="line"><span class="comment">//设置为空，需要从合约中拿出来的值进行赋值</span></span><br><span class="line"><span class="keyword">let</span> candidates = &#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> tokenPrice = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> web3Provider;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.ethereum) &#123;</span><br><span class="line">        web3Provider = <span class="built_in">window</span>.ethereum;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 请求用户授权</span></span><br><span class="line">            <span class="built_in">window</span>.ethereum.enable();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="comment">// 用户不授权时</span></span><br><span class="line">            <span class="built_in">console</span>.error(<span class="string">&quot;User denied account access&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">window</span>.web3) &#123; <span class="comment">// 老版 MetaMask Legacy dapp browsers...</span></span><br><span class="line">        web3Provider = <span class="built_in">window</span>.web3.currentProvider;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        web3Provider = <span class="keyword">new</span> Web3.providers.HttpProvider(<span class="string">&#x27;http://localhost:7545&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    web3 = <span class="keyword">new</span> Web3(web3Provider);</span><br><span class="line">    Voting.setProvider(web3.currentProvider);</span><br><span class="line">    populateCandidates();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.buyTokens = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> accAddrs = <span class="keyword">await</span> web3.eth.getAccounts()</span><br><span class="line">    <span class="keyword">let</span> tokensToBuy = $(<span class="string">&#x27;#buy&#x27;</span>).val();</span><br><span class="line">    <span class="keyword">let</span> _value = tokensToBuy * tokenPrice;</span><br><span class="line">    Voting.deployed().then(<span class="function"><span class="params">VotingInst</span> =&gt;</span> &#123;</span><br><span class="line">        VotingInst.buy(&#123; <span class="attr">value</span>: web3.utils.toWei(_value.toString(), <span class="string">&#x27;ether&#x27;</span>), <span class="attr">from</span>: accAddrs[<span class="number">0</span>] &#125;).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            VotingInst.tokenSold().then(<span class="function"><span class="params">amount</span> =&gt;</span> &#123;</span><br><span class="line">                $(<span class="string">&quot;#tokens-sold&quot;</span>).html(amount.toString());</span><br><span class="line">            &#125;);</span><br><span class="line">            web3.eth.getBalance(VotingInst.address).then(<span class="function"><span class="params">balance</span> =&gt;</span> &#123;</span><br><span class="line">                $(<span class="string">&quot;#contract-balance&quot;</span>).html(web3.utils.fromWei(balance, <span class="string">&#x27;ether&#x27;</span>).toString() + <span class="string">&quot;ETH&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.lookupVoterInfo = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> _address = $(<span class="string">&quot;#voter-info&quot;</span>).val();</span><br><span class="line">    Voting.deployed().then(<span class="function"><span class="params">VotingInst</span> =&gt;</span> &#123;</span><br><span class="line">        VotingInst.voterDetails(_address).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            $(<span class="string">&quot;#tokens-bought&quot;</span>).html(<span class="string">&quot;购买代币总数&quot;</span> + <span class="string">&quot; : &quot;</span> + res[<span class="number">0</span>].toString());</span><br><span class="line">            <span class="keyword">let</span> candidateNames = <span class="built_in">Object</span>.keys(candidates);</span><br><span class="line">            $(<span class="string">&quot;#votes-cast&quot;</span>).empty();</span><br><span class="line">            $(<span class="string">&quot;#votes-cast&quot;</span>).append(<span class="string">&quot;投票详情 : &lt;br&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; candidateNames.length; i++) &#123;</span><br><span class="line">                $(<span class="string">&quot;#votes-cast&quot;</span>).append(candidateNames[i] + <span class="string">&quot;:&quot;</span> + res[<span class="number">1</span>][i].toString() + <span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.voteForCandidate = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> candidateName = $(<span class="string">&quot;#candidate&quot;</span>).val();</span><br><span class="line">    <span class="keyword">let</span> voteTokens = $(<span class="string">&quot;#vote-tokens&quot;</span>).val();</span><br><span class="line">    <span class="keyword">let</span> accAddrs = <span class="keyword">await</span> web3.eth.getAccounts()</span><br><span class="line">    $(<span class="string">&quot;candidate&quot;</span>).val(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    $(<span class="string">&quot;vote-tokens&quot;</span>).val(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    Voting.deployed().then(<span class="function"><span class="params">VotingInst</span> =&gt;</span> &#123;</span><br><span class="line">        VotingInst.voteForCandidate(web3.utils.asciiToHex(candidateName), voteTokens, &#123; <span class="attr">gas</span>: <span class="number">140000</span>, <span class="attr">from</span>: accAddrs[<span class="number">0</span>] &#125;).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            VotingInst.totalVotesFor(web3.utils.asciiToHex(candidateName)).then(<span class="function"><span class="params">count</span> =&gt;</span> &#123;</span><br><span class="line">                $(<span class="string">&quot;#&quot;</span> + candidates[candidateName]).html(count.toString());</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">populateCandidates</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Voting.deployed().then(<span class="function"><span class="params">VotingInst</span> =&gt;</span> &#123;</span><br><span class="line">        VotingInst.allCandidate().then(<span class="function"><span class="params">candidateArray</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; candidateArray.length; i++) &#123;</span><br><span class="line">                <span class="keyword">let</span> candidateName = web3.utils.hexToUtf8(candidateArray[i]);</span><br><span class="line">                <span class="built_in">console</span>.log(candidateName);</span><br><span class="line">                candidates[candidateName] = <span class="string">&#x27;candidate-&#x27;</span> + i;</span><br><span class="line">            &#125;</span><br><span class="line">            setupCandidateRows();</span><br><span class="line">            populateCandidateVotes();</span><br><span class="line">            populateTokenData();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setupCandidateRows</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">Object</span>.keys(candidates).forEach(<span class="function"><span class="params">candidate</span> =&gt;</span> &#123;</span><br><span class="line">        $(<span class="string">&quot;#candidate-rows&quot;</span>).append(<span class="string">&quot;&lt;tr&gt;&lt;td&gt;&quot;</span> + candidate + <span class="string">&quot;&lt;/td&gt;&lt;td id =&#x27;&quot;</span> + candidates[candidate] + <span class="string">&quot;&#x27;&gt;&lt;/td&gt;&lt;/tr&gt;&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">populateCandidateVotes</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> candidateNames = <span class="built_in">Object</span>.keys(candidates);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; candidateNames.length; i++) &#123;</span><br><span class="line">        Voting.deployed().then(<span class="function"><span class="params">VotingInst</span> =&gt;</span> &#123;</span><br><span class="line">            VotingInst.totalVotesFor(web3.utils.asciiToHex(candidateNames[i])).then(<span class="function"><span class="params">count</span> =&gt;</span> &#123;</span><br><span class="line">                $(<span class="string">&quot;#&quot;</span> + candidates[candidateNames[i]]).html(count.toString());</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">populateTokenData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Voting.deployed().then(<span class="function"><span class="params">VotingInst</span> =&gt;</span> &#123;</span><br><span class="line">        VotingInst.totalTokens().then(<span class="function"><span class="params">amount</span> =&gt;</span> &#123;</span><br><span class="line">            $(<span class="string">&quot;#tokens-total&quot;</span>).html(amount.toString());</span><br><span class="line">        &#125;);</span><br><span class="line">        VotingInst.tokenSold().then(<span class="function"><span class="params">amount</span> =&gt;</span> &#123;</span><br><span class="line">            $(<span class="string">&quot;#tokens-sold&quot;</span>).html(amount.toString());</span><br><span class="line">        &#125;);</span><br><span class="line">        VotingInst.tokenPrice().then(<span class="function"><span class="params">price</span> =&gt;</span> &#123;</span><br><span class="line">            tokenPrice = web3.utils.fromWei(price.toString(), <span class="string">&#x27;ether&#x27;</span>);</span><br><span class="line">            $(<span class="string">&quot;#tokens-cost&quot;</span>).html(web3.utils.fromWei(price, <span class="string">&#x27;ether&#x27;</span>).toString() + <span class="string">&quot;ETH&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        web3.eth.getBalance(VotingInst.address).then(<span class="function"><span class="params">balance</span> =&gt;</span> &#123;</span><br><span class="line">            $(<span class="string">&quot;#contract-balance&quot;</span>).html(web3.utils.fromWei(balance, <span class="string">&#x27;ether&#x27;</span>).toString() + <span class="string">&quot;ETH&quot;</span>);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里项目就制作完成了，进入app目录下npm run dev，运行没问题后则投票DApp制作完成。</p>
<h2 id="问题总结："><a href="#问题总结：" class="headerlink" title="问题总结："></a>问题总结：</h2><ol>
<li>web3的1.0版本以前使用web3.eth.accounts查看地址，而现在要使用web3.utils.getAccounts()查看地址。</li>
<li>在web3中使用web3.utils.getAccounts()要异步await，同时所在的函数要使用async保证同步。</li>
<li>本文中大量使用了web3.utils，这都是1.0版本更新后导致的。</li>
<li>新版的metamask和老版的授权方式不同，新版是window.ethereum。老版是window.web3，要注意。</li>
<li>候选者姓名存储到链上后是以bytes32格式存储的，我们前端显示的时候要使用web3.utils.hexToUtf8。</li>
<li>候选者姓名在存储到链上时也要使用bytes32格式，我们对字符串类型要使用web3.utils.asciiToHex。</li>
<li>在运行项目是输入npm run dev报错，如果报错Can’t resolve ‘truffle-contract’则需要 npm install –save truffle-contract。</li>
</ol>

                            </div>

                            
                                <section class="post-copyright">
                                    
                                            
                                                    
                                                            

                                </section>
                                
                                    <section class="post-tags">
                                        <div>
                                            <span>标签:</span>
                                            <span class="tag">
                    
                    
                        <a href="/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/"># 以太坊</a>
                    
                        
                </span>
                                        </div>
                                        <div>
                                            <a href="javascript:window.history.back();">back</a>
                                            <span>· </span>
                                            <a href="/">home</a>
                                        </div>
                                    </section>
                                    <section class="post-nav">
                                        
                                            <a class="prev" rel="prev" href="/2021/04/11/IPFS%E5%85%A5%E9%97%A8/">
                                                IPFS入门学习
                                            </a>
                                            
                                                
                                                    <a class="next" rel="next" href="/2020/12/12/%E5%9F%BA%E4%BA%8ETruffle%E7%9A%84%E6%8A%95%E7%A5%A8DApp%E5%AE%9E%E7%8E%B0/">
                                                        基于Truffle的投票DApp实现
                                                    </a>
                                                    
                                    </section>


                        </article>
</div>
        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Night Scholar | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
